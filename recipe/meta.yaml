##{% set cuda_version = cudatoolkit | replace('.*',"") %}
{% set cuda_version = "11.0" %}
{% set cudnnvars = {
  "10.2": {
    "cudnn_version": {
      "linux64": "7.6.5.32-1",
      "ppc64le": "7.6.5.32-1",
    },
    "os": "rhel7",
    "checksums": {
      "linux64": "317483416b6516c0fb3d38f103bdd315352625c2e16f75aa37bb2a9323dd34c1",
      "ppc64le": "378894e78783f6866e714d85afc199c69754da71cfe8312e0163b5397c713cf4",
    },
    "checksums-dev": {
      "linux64": "644d9e4206371764893408bf961afceaa9ee63175c2670fe9f8577bf5397cf7a",
      "ppc64le": "fdf3d23bfa3ba22bef9e508473ab20affc25d5b84614475d5cbf0b40573ab04b",
    },
  },
  "11.0": {
    "cudnn_version": {
      "linux64": "8.0.4.30-1",
      "ppc64le": "8.0.4.30-1",
    },
    "os": "rhel8",
    "checksums": {
      "linux64": "caf0364d1a2466eb47028992aa12f9f119bf94e4e6da3a997e781b6e03106f99",
      "ppc64le": "55c6a64437a559eb1fdabcd1b176eb343030a9c18b92a0207328562a6b75e712",
    },
    "checksums-dev": {
      "linux64": "d1287669c2a777b49da1a7610c584cdb23c41680e7b76296002bcde0b79fde52",
      "ppc64le": "ae2cfea83dd3d3c529368c6e97e68f071d98ab8bb481fb0994729e065fd335b8",
    },
  },
}
%}
{% set cudnn_version = cudnnvars[cuda_version]["cudnn_version"]["ppc64le"] %}
{% set os = cudnnvars[cuda_version]["os"] %}
{% set arch = "ppc64le" %}  # [ppc64le]
{% set arch = "x64_64" %}  # [x86_64]
  
package:
  name: cudnn
  version: {{ cudnn_version.rsplit('.', 1)[0] + "_" + cuda_version }}

build:
  number: 1

requirements:
  run:
    - cudatoolkit {{ cudatoolkit }}

source:
  - url: https://developer.download.nvidia.com/compute/machine-learning/repos/{{ os }}/{{ arch }}/libcudnn{{ cudnn_version.split('.')[0] }}-devel-{{ cudnn_version }}.cuda{{ cuda_version }}.{{ arch }}.rpm
    sha256: {{ cudnnvars[cuda_version]["checksums-dev"]["ppc64le"] }} # [ppc64le]
    sha256: {{ cudnnvars[cuda_version]["checksums-dev"]["linux64"] }} # [x86_64]
    folder: cudnn-dev
  - url: https://developer.download.nvidia.com/compute/machine-learning/repos/{{ os }}/{{ arch }}/libcudnn{{ cudnn_version.split('.')[0] }}-{{ cudnn_version }}.cuda{{ cuda_version }}.ppc64le.rpm
    sha256: {{ cudnnvars[cuda_version]["checksums"]["ppc64le"] }} # [ppc64le]
    sha256: {{ cudnnvars[cuda_version]["checksums"]["linux64"] }} # [x86_64]
    folder: cudnn

test:
  commands:
    - test -f ${PREFIX}/lib/libcudnn.so
    - test -f ${PREFIX}/lib/libcudnn_static.a

about: 
    license_file: LICENSE
    summary: The NVIDIA CUDA Deep Neural Network library. A GPU-accelerated library of primitives for deep neural networks.

extra:
  recipe-maintainers:
    - open-ce/open-ce-dev-team
